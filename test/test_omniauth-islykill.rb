require 'minitest/autorun'
require 'omniauth-islykill'

class IslykillTest < Minitest::Test
  def test_signed_xml
    token_base64 = "PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4NCjxSZXNwb25zZSB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIg0KeG1sbnM6eHNkPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSIgSUQ9Il8xZDYyZWM0ZS1lZjUwLTRjYTAtYWQ2NS04MDVhMTI2YTVlOTkiDQpWZXJzaW9uPSIyLjAiIElzc3VlSW5zdGFudD0iMjAxNC0wMS0xN1QxNToxNTo1Mi4xNzI1NzYxWiINCkRlc3RpbmF0aW9uPSJodHRwczovL2xvZ2luLmFkdmFuaWEuaXMvaXNsb2dpbi5hc3B4Ig0KeG1sbnM9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpwcm90b2NvbCI+PElzc3Vlcg0KeG1sbnM9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iPsOeasOzw7Bza3LDoSDDjXNsYW5kczwvSXNzdWVyPjxTaWduYXR1cmUNCnhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIj48U2lnbmVkSW5mbz48Q2Fub25pY2FsaXphdGlvbk1ldGhvZA0KQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy9UUi8yMDAxL1JFQy14bWwtYzE0bi0yMDAxMDMxNSIgLz48U2lnbmF0dXJlTWV0aG9kDQpBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyNyc2Etc2hhMSIgLz48UmVmZXJlbmNlIFVSST0iI18xZDYyZWM0ZS1lZjUwLTRjYTAtDQphZDY1LTgwNWExMjZhNWU5OSI+PFRyYW5zZm9ybXM+PFRyYW5zZm9ybQ0KQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjZW52ZWxvcGVkLXNpZ25hdHVyZSIgLz48VHJhbnNmb3JtDQpBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIgLz48L1RyYW5zZm9ybXM+PERpZ2VzdE1ldGhvZA0KQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGVuYyNzaGEyNTYiDQovPjxEaWdlc3RWYWx1ZT51RG1ZYmlpQ3IzQnRxM3gySUd2SGlYbkdlSmowY1JDbmM5Y0hyZVFzRkZjPTwvRGlnZXN0VmFsdWU+PC9SZWZlcmVuY2U+PC9TaWduZWRJDQpuZm8+PFNpZ25hdHVyZVZhbHVlPkhuRkNsbURoTG1qRy9SQmVpRmlHMlhzSUI1amhSQUFYbUFjTktwK3VEWW5MdndaV1l2VUFaZzNwa09aOXZqeTJocFE4TEtZKy9BDQpyWHJ3TCtwNndodzh5YUhuYnZJWTlSOTVHck1oR2xlNVF5RFE5UkpCN0R2VW00bDFWby90YVI0TmVCNVkvdnBVdWFlbHFlRnN6NURZN0l6ZnlmQlNrU3V5ZFhJUENqDQpkNzY5dUk1SmtwZzVPM0FoV1o1b1MzWWpQNWJVMmdodmdtNGxVVGNrWWxsNXUxT2dLR2xTL3dva3NsMldybFVjdkF3MENGbnN6NG5sTjdITTVETUoxNVZNUTk2aHZoDQphR0JRaVZnZjVaZVlYa3dGclpqbDNQMXJWYm5wN0NRNHBLVHNnd2o4ZUU1Q2FuejBlamRlYXRJcENNZFBoMVN6YklsSUtDbWx1Mk50clNyZz09PC9TaWduYXR1cmVWDQphbHVlPjxLZXlJbmZvPjxYNTA5RGF0YT48WDUwOUNlcnRpZmljYXRlPk1JSUdERENDQlBTZ0F3SUJBZ0lDQ2JZd0RRWUpLb1pJaHZjTkFRRUZCUUF3Z1pJeEN6QUpCDQpnTlZCQVlUQWtsVE1STXdFUVlEVlFRRkV3bzFNakV3TURBeU56a3dNUll3RkFZRFZRUUtFdzFCZFdSclpXNXVhU0JsYUdZdU1TTXdJUVlEVlFRTEV4cFZkR2RsWm1GDQp1WkdrZ1luVnVZV1JoY25OcmFXeHlhV3RxWVRFV01CUUdBMVVFQ3hNTlRXbHNiR2x6YTJsc2NtbHJhVEVaTUJjR0ExVUVBeE1RVkhKaGRYTjBkWElnWW5WdVlXUjFjDQpqQWVGdzB4TXpBNE1UTXhNelUyTXpGYUZ3MHhOREE0TVRNeE16VTJNekZhTUlIQ01Rc3dDUVlEVlFRR0V3SkpVekVlTUJ3R0ExVUVDZ3dWdzU1cXc3UERzSE5yY3NPDQpoSU1PTmMyeGhibVJ6TVJnd0ZnWURWUVFMRXc5Q2RXNWhaR0Z5YzJ0cGJISnBhMmt4SlRBakJnTlZCQXNNSEZWdVpHbHljbWwwZFc0Z1pjT3dZU0JoZGNPd2EyVnViDQptbHVaeUF4SFRBYkJna3Foa2lHOXcwQkNRRVdEblpsY210QWFYTnNZVzVrTG1sek1STXdFUVlEVlFRRkV3bzJOVEF6TnpZd05qUTVNUjR3SEFZRFZRUURFeFZKYm01DQp6YTNKaGJtbHVaeUJKYzJ4aGJtUXVhWE13Z2dFaU1BMEdDU3FHU0liM0RRRUJBUVVBQTRJQkR3QXdnZ0VLQW9JQkFRQ2tXektIa3czY2tSYjU1d1g5SzkyUmo0eU52DQpPSXFqOUtVWUFhTzZkbXpTUkt0WjNBUHBic1BMK2QxZjdPYnpTeXZQWjZobDBIK21nczFsNW5zQ2M0QjFFMHhSOXQ3ZDVBZ3dGNjZ4WU4vemVwUGZKOTVJVjN6bG1uDQpuaitDUEc0cXV5SnM2SEVneXhOSDc5WDl2NWxxK3hlMFd0b0hnYVkyL3ZUdmNlT1BPa2Rrc0RuQ0Z1RC9Pdmp2VnlaMGJUQjNBZTBrQk5iSlJRQ0FXUnB1VlNwMkkzDQp4RWZYaGhxYnVaT3N2K1dVdmFPTDFqYW51T1dZaTlkNklvYUM4Q08zUlBSdlJjUzlxNXEvaUR1MkhZRUNpcVQxWkhYdSt1N1pvc0YwVG4xbHQwdS8vOEU2WUMwNTFGDQorRTJYREN0b3FpTzdRUzBzRTlGbnR4cG1iZnYwd3JsTDFBZ01CQUFHamdnSTRNSUlDTkRBTUJnTlZIUk1CQWY4RUFqQUFNSUlCSEFZRFZSMGdCSUlCRXpDQ0FROHdnDQpnRUxCZ2xnZ21BQkFnRUJCQUV3Z2Ywd2djUUdDQ3NHQVFVRkJ3SUNNSUczR29HMFZHaHBjeUJqWlhKMGFXWnBZMkYwWlNCcGN5QnBiblJsYm1SbFpDQm1iM0lnWkdsDQpuYVhSaGJDQnphV2R1WVhSMWNtVnpJR0Z1WkNCaGRYUm9aVzUwYVdOaGRHbHZiaTRnVkdocGN5QmpaWEowYVdacFkyRjBaU0JtZFd4bWFXeHpJSFJvWlNCeVpYRjFhDQpYSmxiV1Z1ZEhNZ2IyWWdibTl5YldGc2FYcGxaQ0JqWlhKMGFXWnBZMkYwWlNCd2IyeHBZM2tnS0U1RFVDa2daR1ZtYVc1bFpDQnBiaUJGVkZOSklGUlRJREV3TWlBDQp3TkRJdU1EUUdDQ3NHQVFVRkJ3SUJGaWhvZEhSd09pOHZZM0F1WVhWa2EyVnVibWt1YVhNdmRISmhkWE4wZFhKaWRXNWhaSFZ5TDJOd01ITUdDQ3NHQVFVRkJ3RUJCDQpHY3daVEFqQmdnckJnRUZCUWN3QW9ZWGFIUjBjRG92TDI5amMzQXVZWFZrYTJWdWJta3VhWE13UGdZSFlJSmdBZ0ZqQm9ZemFIUjBjRG92TDJOa2NDNWhkV1JyWlc1DQp1YVM1cGN5OXphMmxzY21scmFTOTBjbUYxYzNSMWNtSjFibUZrZFhJdWNEZGlNQXNHQTFVZER3UUVBd0lGNERBZkJnTlZIU01FR0RBV2dCUnY3TnNSTEFFRGF4dGdyDQpyYjRhTmxBQWMyT09EQkNCZ05WSFI4RU96QTVNRGVnTmFBemhqRm9kSFJ3T2k4dlkzSnNMbUYxWkd0bGJtNXBMbWx6TDNSeVlYVnpkSFZ5WW5WdVlXUjFjaTlzWVhSDQpsYzNRdVkzSnNNQjBHQTFVZERnUVdCQlFQaWtBeGlmcmlVU1pyUU1yV2p4eVkyUGpFZHpBTkJna3Foa2lHOXcwQkFRVUZBQU9DQVFFQUJNTWFDR0FCa2I0MGJPckZ4DQpaSU0rWURlWVlHbmU0bnBkTTRRR3Vwa3YyYURQMmJPaG9oR3c5ckNiYXhMOWxtOEJIR0h0bVd3ZXJ3WC8zbHJ0bnQzNjdwTWMvVFJvbit2VmdueG85d3ljbVAydTJQDQpOeVhyRUk4WDI5N1BCSm9LbFovb3VEbklUVnFIL0JWdndhUFNpWXF6NzhoL2t6UVJOdEZER0xUOE8vQ3FmQ1JCNXFtR054OEkwMXRjT01xNEVIcmMvaHdIUWMxZm9nDQp0SEo3SmFDNU5NTzFiZzg1M3lsMlhDM0R3dzhPbXpBSGtDRnZLeDhhQmVFeWllc1hKSHBGajI5MktvaEhaaE9qMXlSNWVvOWJkcWRjalRHa1dSbjBoTis2dlprZE1CDQpJcWhrTlM3a3l4R3B2eW5pQ2UzVkpaSWhhWEhJWnJieDFhWUdseW9DdnhnPT08L1g1MDlDZXJ0aWZpY2F0ZT48L1g1MDlEYXRhPjwvS2V5SW5mbz48L1NpZ25hdHVyDQplPjxTdGF0dXM+PFN0YXR1c0NvZGUgVmFsdWU9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpzdGF0dXM6U3VjY2VzcyIgLz48L1N0YXR1cz48QXNzZXJ0aW9uDQpWZXJzaW9uPSIyLjAiIElEPSJfMzIxNDI3ZDEtM2E2Yy00ZDU2LTlhZGEtOGQ5MDkyNGY2MDE0IiBJc3N1ZUluc3RhbnQ9IjIwMTQtMDEtDQoxN1QxNToxNTo1Mi4xNzI1NzYxWiIgeG1sbnM9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iPjxJc3N1ZXI+w55qw7PDsHNrcsOhDQrDjXNsYW5kczwvSXNzdWVyPjxTdWJqZWN0PjxOYW1lSUQNCk5hbWVRdWFsaWZpZXI9ImlzbGFuZC5pcyI+SW5uc2tyw6FuaW5nYXLDvmrDs251c3RhPC9OYW1lSUQ+PFN1YmplY3RDb25maXJtYXRpb24NCk1ldGhvZD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmNtOmJlYXJlciI+PFN1YmplY3RDb25maXJtYXRpb25EYXRhIEFkZHJlc3M9IjEyNy4wLjAuMSINCk5vdE9uT3JBZnRlcj0iMjAxNC0wMS0xN1QxNToyNTo1Mi4xNzQ1NzYzWiIgUmVjaXBpZW50PSJodHRwOi8vbG9jYWxob3N0OjYzODQxL0dldEJhY2suYXNweCINCi8+PC9TdWJqZWN0Q29uZmlybWF0aW9uPjwvU3ViamVjdD48Q29uZGl0aW9ucyBOb3RCZWZvcmU9IjIwMTQtMDEtMTdUMTU6MTU6NTIuMTc0NTc2M1oiDQpOb3RPbk9yQWZ0ZXI9IjIwMTQtMDEtDQoxN1QxNToyNTo1Mi4xNzQ1NzYzWiI+PEF1ZGllbmNlUmVzdHJpY3Rpb24+PEF1ZGllbmNlPmxvZ2luLmFkdmFuaWEuaXM8L0F1ZGllbmNlPjwvQXVkaWVuY2VSZXN0DQpyaWN0aW9uPjwvQ29uZGl0aW9ucz48QXV0aG5TdGF0ZW1lbnQgQXV0aG5JbnN0YW50PSIyMDE0LTAxLQ0KMTdUMTU6MTU6NTIuMTcyNTc2MVoiPjxTdWJqZWN0TG9jYWxpdHkgQWRkcmVzcz0iMjEyLjMwLjIyNS4xMzkiDQovPjxBdXRobkNvbnRleHQ+PEF1dGhuQ29udGV4dENsYXNzUmVmPnVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphYzpjbGFzc2VzOlRMU0NsaWVudDwvQXV0aG5DDQpvbnRleHRDbGFzc1JlZj48L0F1dGhuQ29udGV4dD48L0F1dGhuU3RhdGVtZW50PjxBdHRyaWJ1dGVTdGF0ZW1lbnQ+PEF0dHJpYnV0ZSBOYW1lPSJVc2VyU1NOIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OmJhc2ljIg0KRnJpZW5kbHlOYW1lPSJLZW5uaXRhbGEiPjxBdHRyaWJ1dGVWYWx1ZQ0KeHNpOnR5cGU9InhzZDpzdHJpbmciPjEyMzQ1Njc4OTA8L0F0dHJpYnV0ZVZhbHVlPjwvQXR0cmlidXRlPjxBdHRyaWJ1dGUgTmFtZT0iTmFtZSINCk5hbWVGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphdHRybmFtZS1mb3JtYXQ6YmFzaWMiDQpGcmllbmRseU5hbWU9Ik5hZm4iPjxBdHRyaWJ1dGVWYWx1ZSB4c2k6dHlwZT0ieHNkOnN0cmluZyI+SsOzbg0KSsOzbnNzb248L0F0dHJpYnV0ZVZhbHVlPjwvQXR0cmlidXRlPjxBdHRyaWJ1dGUgTmFtZT0iQXV0aGVudGljYXRpb24iDQpOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OmJhc2ljIg0KRnJpZW5kbHlOYW1lPSJBdcOwa2VubmluZyI+PEF0dHJpYnV0ZVZhbHVlIHhzaTp0eXBlPSJ4c2Q6c3RyaW5nIj5SYWZyw6ZuDQpza2lscsOta2k8L0F0dHJpYnV0ZVZhbHVlPjwvQXR0cmlidXRlPjxBdHRyaWJ1dGUgTmFtZT0iSVBBZGRyZXNzIg0KTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDpiYXNpYyINCkZyaWVuZGx5TmFtZT0iSVBUYWxhIj48QXR0cmlidXRlVmFsdWUNCnhzaTp0eXBlPSJ4c2Q6c3RyaW5nIj4xMjcuMC4wLjE8L0F0dHJpYnV0ZVZhbHVlPjwvQXR0cmlidXRlPjxBdHRyaWJ1dGUgTmFtZT0iVXNlckFnZW50Ig0KTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDpiYXNpYyINCkZyaWVuZGx5TmFtZT0iTm90YW5kYVN0cmVuZ3VyIj48QXR0cmlidXRlVmFsdWUgeHNpOnR5cGU9InhzZDpzdHJpbmciPk1vemlsbGEvNS4wIChXaW5kb3dzIE5UDQo2LjE7IFdPVzY0OyBydjoyNi4wKSBHZWNrby8yMDEwMDEwMSBGaXJlZm94LzI2LjA8L0F0dHJpYnV0ZVZhbHVlPjwvQXR0cmlidXRlPjxBdHRyaWJ1dGUNCk5hbWU9IkF1dGhJRCIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDpiYXNpYyINCkZyaWVuZGx5TmFtZT0iQXXDsGtlbm5pbmdhck7Dum1lciI+PEF0dHJpYnV0ZVZhbHVlIHhzaTp0eXBlPSJ4c2Q6c3RyaW5nIj4wODA3REE4RC0zMjk5LTRGRjQtDQpCRUIyLTU0NzI3QTUwRkZCRDwvQXR0cmlidXRlVmFsdWU+PC9BdHRyaWJ1dGU+PEF0dHJpYnV0ZSBOYW1lPSJEZXN0aW5hdGlvblNTTiINCk5hbWVGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphdHRybmFtZS1mb3JtYXQ6YmFzaWMiDQpGcmllbmRseU5hbWU9Iktlbm5pdGFsYU3Ds3R0YWthbmRhIj48QXR0cmlidXRlVmFsdWUNCnhzaTp0eXBlPSJ4c2Q6c3RyaW5nIj41OTAyNjk3MTk5PC9BdHRyaWJ1dGVWYWx1ZT48L0F0dHJpYnV0ZT48L0F0dHJpYnV0ZVN0YXRlbWVudD48L0Fzc2VydGlvbj4NCjwvUmVzcG9uc2U+"
    islykill_xml_saml_response = Base64.decode64(token_base64)
    signedDocument = SignedXml::Document(islykill_xml_saml_response)
    if !signedDocument.is_verified?
        raise OmniAuth::Strategies::Islykill::ValidationError.new("Islykill response not valid")
    end

    # response is valid so we extract the information using xpath
    xml_doc = REXML::Document.new(islykill_xml_saml_response)

    prefix='Response/Assertion/AttributeStatement/Attribute[@Name="'
    postfix='"]/AttributeValue'

    @attributes={        
        name: REXML::XPath.first(xml_doc,"#{prefix}uid#{postfix}").text,
        kennitala: REXML::XPath.first(xml_doc,"#{prefix}mail#{postfix}").text,
        provider: REXML::XPath.first(xml_doc,"#{prefix}eduPersonAffiliation#{postfix}").text
    }
    
    @name_id = REXML::XPath.first(xml_doc,"Response/Assertion/Subject/NameID/@NameQualifier").value()

    if @name_id.nil? || @name_id.empty?
      raise OmniAuth::Strategies::Islykill::ValidationError.new("SAML response missing 'name_id'")
    end

  end
   
end